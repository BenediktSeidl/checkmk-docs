include::global_attr.adoc[]
= Support Diagnostics
:revdate: draft
:title: Collect diagnostic information
:description: Collect diagnostic information for failure analysis


== Introduction

Should you ever be confronted with problems in {CMK} that you cannot solve
solve them by yourself -- with the help of this manual -- you can use the
the official link:https://checkmk.com/support.html[{CMK}-Support]]
and the link:https://forum.checkmk.com/[{CMK}-Forum] offer you two excellent
contact points. In both cases a precise description of the error or problem is
error or problem is extremely helpful. In addition, certain
information about your {CMK} environment is mandatory for a quick analysis and solution.
and solution. The most basic information
is surely the link:cmk_versions.html[version] and the
link:intro.html#editions[Edition] of {CMK}. Depending on the case, however, a considerably
considerably long list of information may be necessary to figure out your problem.
to get to the bottom of your problem.

And this is where Support Diagnostics comes in. Instead of sending you the
list mentioned above and send you on a scavenger hunt through the different areas of
through the different areas of {CMK}, you can, with just a few clicks in the graphical
a few clicks in the graphical interface, you can create a tailor-made package of
of information (called _dump_ in the following). Here
you decide for yourself to what extent you want to include configuration files that may contain
possibly confidential information, also want to pack.


== Compile support information

=== Select instance

After clicking on [.guihint]#Setup > Maintenance > Support diagnostics# you will see
the following tidy picture:

image::support_diagnostics.png[]

If you are using distributed monitoring, you can specify in the first field the
instance ([.guihint]#Site#) from which you want to collect the data to be selected in the
to be collected.

=== General information

Under [.guihint]#General information# you will find basically only a hint,
that the information about the {CMK} version and the used operating system will be
will be included in any case. If you were to leave it at that -- i.e. select none of the
options -- and start the collection of the data via [.guihint]#Collect dump#, you would get a file that is
you would get a file containing only the following data:

.general.json
[{file}]
----
{
    }, "arch": "x86_64",
    }, "core": "cmc",
    }, "edition": "cee",
    }, "os": "focal",
    "python_paths": [
        "/opt/omd/versions/2020.12.03.cee/bin",
        "/omd/sites/today/local/lib/python3",
        ...
        "/omd/sites/today/lib/python3"
    ],
    "python_version": "3.8.6 (default, Oct 22 2020, 16:40:44) \n[GCC 10.1.0]",
    "time": 1607002909.767516,
    "time_human_readable": "2020-12-03 14:41:49.767516",
    "version": "2.0.0b1"
}
----

=== Optional general information

Under [.guihint]#Optional general information# you will then find choices
which you can compile in advance to suit your question, or which can be
or which may be explicitly requested by the support.

If you choose [.guihint]#Local Files# here, {CMK} will additionally create an overview
of all files located in the `~/local/` directory of your instance. This can
useful if your local customizations are related to a recent update of {CMK}.
update of {CMK} are incompatible. Also all installed MKPs
are also recorded here.

With the selection of [.guihint]#OMD Config# you can add to the dump the information about
your configuration of OMD. These correspond exactly to what you
on the command line with the `omd config show` command.
command.

.omd_config.json
[{file}]
----
{
    "CONFIG_ADMIN_MAIL": "",
    "CONFIG_APACHE_MODE": "own",
    "CONFIG_APACHE_TCP_ADDR": "127.0.0.1",
    "CONFIG_APACHE_TCP_PORT": "5000",
    "CONFIG_AUTOSTART": "on",
    "CONFIG_CORE": "cmc",
    "CONFIG_LIVEPROXYD": "on",
    "CONFIG_LIVESTATUS_TCP": "on",
    "CONFIG_LIVESTATUS_TCP_ONLY_FROM": "0.0.0.0 ::/0",
    "CONFIG_LIVESTATUS_TCP_PORT": "6557",
    "CONFIG_LIVESTATUS_TCP_TLS": "off",
    "CONFIG_MKEVENTD": "on",
    "CONFIG_MKEVENTD_SNMPTRAP": "on",
    "CONFIG_MKEVENTD_SYSLOG": "on",
    "CONFIG_MKEVENTD_SYSLOG_TCP": "on",
    "CONFIG_MULTISITE_AUTHORISATION": "off",
    "CONFIG_MULTISITE_COOKIE_AUTH": "off",
    "CONFIG_NAGIOS_THEME": "classicui",
    "CONFIG_NSCA": "off",
    "CONFIG_NSCA_TCP_PORT": "5667",
    "CONFIG_PNP4NAGIOS": "on",
    "CONFIG_TMPFS": "on"
}
----

If you check the [.guihint]#{CMK} Overview# checkbox, general information about
about *all* instances running on your {CMK} server.
It also creates a list of all installed {CMK} versions.
And in case the instance selected above is the node of a cluster
this fact will also be recorded here.

After activating the [.guihint]#{CMK} Configuration files# option you have
the possibility to remove more or less confidential data from this part of the
of the package -- via the [.guihint]#Pack only Low sensitivity files# preference.
All files you can select here come from the directory
`~/etc/checkmk` and its subdirectories. You can see a detailed list
directly below the dropdown menu. With the option
[.guihint]#Select individual files from list# you even have the option to include only
specific files into the dump.

With this option you can also see which files have which confidentiality level
so High/High (H) for files with e.g. passwords,
Medium/Middle (M), if they contain addresses or usernames for example, or
finally Low/Low (L).

image::support_diagnostics_sensivity_levels.png[]

Next, you have the option to [.guihint]#Performance Graphs of {CMK} Server#
with it. Especially in case of problems with the performance of a {CMK} instance
these reports are almost always requested. So it is a good idea to include them in case of a
performance problem. The [.guihint]#Support diagnostics#
will do the work for you to manually generate a number of reports as PDFs.
manually. Among others the reports of the service
[.guihint]#OMD mysite performance# for the last 25 hours and the last 35 days.
are generated.

=== Component specific information

The [.guihint]#Component specific information# section again allows you to decide very
granular about which information from your global {CMK} settings, your
{CMK} settings, your hosts and folders, and your alerting settings.
alerting settings should be included in the dump.

*IMPORTANT:* Depending on the configuration, the files you select here may contain
confidential information, such as passwords, depending on your configuration,
may be contained. In normal operation, this data is protected by the fact that only the
instance user and administrators have access to it. If you make this data available to third parties for
analysis purposes, you should proceed with great caution.
proceed with great caution.

In the [.guihint]#Global Settings# sub-item you will find all [.guihint]#global.mk-#files of the
individual components of your {CMK} instance, such as the
dynamic configuration daemon or the live status proxy daemon.

The information that can be selected via the subitem [.guihint]#Hosts and Folders# can, among other things
can, among other things, help to find unfavorable rule sets and
errors in the host configuration.

In the [.guihint]#Notifications# section you will find, in addition to the corresponding
configuration files and a selection of log files. In case of
difficulties with your notifications you or in last instance the
{CMK} support can often find the cause in these logs.

*Note:* In order to find as much detailed information as possible in the logs about
about the behavior of {CMK} in the logs, it may be necessary to change the log level in {CMK}.
log level in {CMK} for a short time. The corresponding
settings can be found via [.guihint]#Setup > General > Global settings.# On this page, simply enter `logging'.
on this page, type `logging` into the [.guihint]#Filter settings# field
and then set for example the log level for the [.guihint]#Core# to [.guihint]#Debug.#
If you now simply let the instance continue to run for a few minutes or repeat a
reproducible error, the chance increases that information about this
information about it in the log.


== Support Diagnostics via the command line

As is often the case in {CMK}, this task can be easily done from a terminal.
to do this task. With the command `cmk` and the option
`--create-diagnostics-dump` this can be done easily. For all
options described above you can append the corresponding parameter to the command.
parameter to the command.

[{shell}]
----
cmk --create-diagnostics-dump --local-files --omd-config --performance-graphs
----

The following options complete the output of the command:

[cols="40,~"]
|===

|--local-files |List of all installed, unpackaged, and optional files below `$OMD_ROOT/local`. This also includes information about installed MKPs.
|--omd-config |Contents of the `~/etc/omd/site.conf` file.
|--checkmk-overview |Information from [.guihint]#HW/SW inventory node Software > Applications > {CMK}# of the {CMK} server.
|--checkmk-config-files FILE,FILE ... |All .mk and .conf files from the `~/etc/checkmk` directory.
|--checkmk-log-files FILE,FILE ... |All log files (.log and .state) from `~/var/log`.
|--performance-graphs |Performance graphs (e.g. CPU load, CPU utilization) of the {CMK} server.
|===


These and all other options of the `cmk` command can be found as usual
in the output of `cmk --help`.

== Missing information in diagnostic dump

=== Current agent needed

To be able to output certain information in the Support Diagnostics, you must
make sure that the {CMK} servers have at least the agent with the version number
version number 2.0.0 is installed. In particular, the information that comes from
the [.guihint]#HW/SW Inventory# of the {CMK} server was not provided at all in older versions of the
Agent were not provided at all.

=== Label cmk/check_mk_server:yes

The Support Diagnostics depend on the {CMK} servers in your environment being
environment are labeled accordingly. If you are missing some data in a
dump, please check if your {CMK} servers are labeled with the
label `cmk/check_mk_server:yes`.