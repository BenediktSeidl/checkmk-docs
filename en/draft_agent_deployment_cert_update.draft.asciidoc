:revdate: draft

In agent_deployment als neuer Punkt 3

Unter 1.2 Signaturschlüssel: Auf diesen Part verweisen

== Signaturschlüssel austauschen

Sie haben Ihre Agenten, wie oben beschrieben, mit einem Signaturschlüssel
versehen, damit die Integrität eines neuen Agenten bei einem Update
sichergestellt werden kann. Wenn Sie diese Schlüssel nun wechseln wollen,
müssen Sie ein bestimmtes Prozedere einhalten: Die Agenten werden zunächst
mit einem neuen, zusätzlichen Schlüssel ausgestattet und die Agenten auf
allen Hosts aktualisiert -- *bevor* der alte Schlüssel entfernt wird. In
diesem Zwischenstand vertrauen die Hosts dann also beiden Schlüsseln. Sobald
die Konfiguration mit beiden Schlüsseln auf allen Hosts aktiv ist, kann
der alte Schlüssel aus dem System gelöscht werden. Nach einer nochmaligen
Aktualisierung der Agenten ist dann nur noch der neue Schlüssel aktiv.

Wird diese Reihenfolge nicht eingehalten, kann das Update nicht funktionieren,
weil dem Paket, welches Checkmk dem Host übergibt nicht vertraut wird.
In diesem Fall müssten alle betroffenen Agenten manuell aktualisiert werden.

Das Prozedere Schritt für Schritt:

. Neuen Schlüssel unter [.guihints]#Monitoring Agents => SignatureKeys# erstellen.
. Neuen Schlüssel unter [.guihints]#Monitoring Agents => Rules => AutomaticUpdates (Linux, Windows) => AgentUpdater# aktivieren.
. Änderungen über [.guihints]#Activate Changes# aktivieren.
. Agenten backen.
. Agenten über ICON[icon_signature_key.png] mit neuem und altem Schlüssel signieren.
COMMENT[MA: Ich bin mir nicht sicher, ob man wirklich mit beiden Schlüsseln signieren muss. Es könnte auch sein, dass es reicht, wenn man mit dem alten signiert.]
COMMENT[ML: Da bin ich auch von ausgegangen - bin aber lieber auf Nummer sicher gegangen. Zumal man so schön sehen kann, dass beide Signaturen gleichzeitig aktiv sind. Wenn alles soweit fertig ist probiere ich es nochmal aus und ändere dann.]
. Test auf Checkmk-Server: Unter [.guihints]#WATO => Monitoring Agents# werden in der Spalte [.guihints]#Signed# beide Schlüssel angegeben und ebenso im Feld [.guihints]#Signature keys the agent will accept:# (siehe Bild unten).
. Test auf Host: Der Befehl [.guihints]#cmk-update-agent --verbose# zeigt die Anzahl der Signaturschlüssel.
. Warten, bis alle Agenten auf allen Hosts aktualisiert wurden; zu sehen unter [.guihints]#Monitoring Agents => AutomaticUpdates => UpdateStatus}}.# 
. Alten Schlüssel unter [.guihints]#Monitoring Agents => Rules => AutomaticUpdates (Linux, Windows) => AgentUpdater# deaktivieren.
. Alten Schlüssel unter [.guihints]#Monitoring Agents => SignatureKeys# löschen.

Das folgende Bild zeigt den zwischenzeitlichen Status mit zwei aktiven Signaturschlüsseln:

image::bilder/agent_deployment_signature_key_update.png[align=border]

== TLS-Zertifikate austauschen

Sofern Sie Ihr Monitoring via [agent_linux#ssh|TLS abgesichert haben], müssen Sie ...
